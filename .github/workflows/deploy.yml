name: Courses Periodic Update

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * 0'

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      COURSES_A: 67504 72120 80430 67125 72942 80114 67528 67594 67829 72107 72334 72336 72362 72665 88893 81817 94510 80131 80031 80134 80034 72160 69174 76559 80181 67101 67312
      SEMESTER_A: a
      COURSES_B: 67577 72154
      SEMESTER_B: b
      HUJIYEAR: 2023
      CHEESEYEAR: 2022
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - name: Set up Python
        uses: actions/setup-python@v2.3.2
        with:
          python-version: 3.9
          cache: pip
      - name: Install requirements for huji-cheesefork downloader
        run: |
          python -m pip install --upgrade pip
          pip install wheel setuptools
          cd huji-cheesefork
          pip install -r requirements.txt
          cd ..
      - name: Download specific courses
        run: |
          cd huji-cheesefork
          mkdir downloaded_courses
          python downloader.py -c ${{env.COURSES_A}} -s ${{env.SEMESTER_A}} -y ${{env.HUJIYEAR}} -d downloaded_courses
          python downloader.py -c ${{env.COURSES_B}} -s ${{env.SEMESTER_B}} -y ${{env.HUJIYEAR}} -d downloaded_courses
          cd ..
      - name: Save courses into correct format
        run: |
          python collect_courses.py huji-cheesefork/downloaded_courses ./deploy/courses ${{env.CHEESEYEAR}} ${{env.HUJIYEAR}} ${{env.SEMESTER_A}}
          python collect_courses.py huji-cheesefork/downloaded_courses ./deploy/courses ${{env.CHEESEYEAR}} ${{env.HUJIYEAR}} ${{env.SEMESTER_B}}
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
